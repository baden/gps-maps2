<html>
<head>
  <link type="text/css" href="/stylesheets/config.css" rel="stylesheet">
  <link href="/plugins/colorpicker/css/colorpicker.css" rel="stylesheet" type="text/css"/>
  <script src="/plugins/colorpicker/js/colorpicker.js"></script>
  <script>
	$(document).ready(function() {
		log('Загрузка закладки. Конфигурация.');
	});

  	var sys_imeis = [];
  	var sys_descs = [];

	{% if admin %}
	function sendGet(url) {
		var xhr = new XMLHttpRequest();
		xhr.open('GET', url, true);
		xhr.send();
	}
	{% endif %}

	function saveconfig(it, val){
		config.ui[it] = val;
		$.ajax({
		  url: '/api/system/config?akey=' + config.akey,
		  dataType: 'json',
		  data: config.ui,
		  type: 'POST',
		  success: function(){log('Saved.');}
		});
	}


	function UpdateSysList(){
		//$.getJSON("/api/info?acckey={{ account.key }}", function (data) {
		$.getJSON('/api/info?acckey='+config.akey, function (data) {
			if(data){
				$("#config_sys_list").empty();
				sys_imeis = [];
				sys_descs = [];
				for(var i in data.info.account.systems){
					var imei = data.info.account.systems[i].imei;
					sys_imeis.push(imei);
					sys_descs.push(data.info.account.systems[i].desc);
					$("#config_sys_list").append(
						'<li class="sli" index='+i+' imei="'+imei+'"><span class="ui-icon ui-icon-arrowthick-2-n-s mm msp"></span>' +
						'<span class="bico hl mm" title="Выбрать пиктограмму" index='+i+'>P</span>' +
						'<span class="bconf hl mm" title="Настроить систему" index='+i+'>C</span>' +
						'IMEI:' + imei + ' <span id="sysdsc_'+imei+'">' + data.info.account.systems[i].desc + '</span>'+
						'<button class="key bdesc" title="Изменить описание" index='+i+'>...</button>' +
						'</li>'
					);
				}
				$(".key").button();
				$("#config_list").accordion("resize");
				$(".sli").bind('contextmenu', function(e) {
					//alert('Config');
					//$("body").append('<div style="position: absolute; left: 0px; top: 0px; border:1px solid black; width: 100px; height: 200px;">Menu</div>');
					$("#popup-sys").dialog('open');
                  			return false;
        			});
				$(".bdesc").click(function(){
					//alert(this.attributes['imei'].value);
					var i = this.attributes['index'].value;
					$("#sysdesc_imei").html(sys_imeis[i])
					$("#sys_desc").val(sys_descs[i]);
					log('Dialog: dialog-sys-desc ' + sys_imeis[i] + ' (' + sys_descs[i] + ')');
					$("#dialog-sys-desc").dialog('open');
				});
			}
		});
	}

	$(document).ready(function() {
		$("#nav_config").button("option", "disabled", true);
		// a workaround for a flaw in the demo system (http://dev.jqueryui.com/ticket/4375), ignore!
		//$("#dialog:ui-dialog").dialog("destroy");

		//$('#switcher').themeswitcher();

		/*$("button").button();*/
		$("#button_sys_update").click(UpdateSysList)
		$("#button_sys_add").click(function(){
			//alert('a');
			$("#dialog-addsys").dialog('open');
		});
		UpdateSysList();

		/*
		$("#get_a_path").click(function(){
			var skey = "{{ account.systems.0.key }}";// aglncHMtbWFwczJyIQsSCERCU3lzdGVtIhNzeXNfMzU2ODk1MDM1Mzc2MjQ2DA";
			var from = "01012010000000";
			var to = "31122010000000";
			GetPath(skey, from, to);
		});
		$("#clear_a_path").click(function(){
			var skey = "{{ account.systems.0.key }}";// aglncHMtbWFwczJyIQsSCERCU3lzdGVtIhNzeXNfMzU2ODk1MDM1Mzc2MjQ2DA";
			ClearPath(skey);
		});
		$("#get_a_days").click(function(){
			var skey = "{{ account.systems.0.key }}";// aglncHMtbWFwczJyIQsSCERCU3lzdGVtIhNzeXNfMzU2ODk1MDM1Mzc2MjQ2DA";
			DayList(skey);
		});
		*/

		$("#dialog-addsys").dialog({
			width: 400,
			height: 200,
			modal: true,
			autoOpen: false,
			buttons: {
				'Добавить систему.': function() {
					var imei = document.getElementById('addsys_imei').value;
					//var phone = document.getElementById('addsys_phone').value;
					//$.getJSON("/config?cmd=addsys&imei=" + imei + "&phone=" + phone, function (data) {
					//$.getJSON("/api/sys/add?acckey={{ account.key }}&imei=" + imei, function (data) {
					$.getJSON('/api/sys/add?acckey='+config.akey+'&imei=' + imei, function (data) {
						//window.location = "/config";
						//$(this).dialog('close');
						if(data.result){
							result = data.result;
							if(result == "not found"){
								//alert("Система не найдена. возможно система ни разу не выходила на связь с сервером.");
								$("#dialog-addsys-not-found").dialog('open');
							} else if(result == "already"){
								//alert("Вы уже наблюдаете за этой системой");
								$("#dialog-addsys-already").dialog('open');
							} else if(result == "added") {
								UpdateSysList();
								//window.location = "/config";
							}
						}
					});
					$(this).dialog('close');
				},
				'Отменить': function() {
					$(this).dialog('close');
				}
			}
		});
		//$("#dialog-addsys").dialog('open');

		$("#dialog-sys-desc").dialog({
			width: 500,
			height: 150,
			modal: true,
			autoOpen: false,
			buttons: {
				'Применить изменения.': function() {
					var imei = $("#sysdesc_imei").html(); //document.getElementById('sysdesc_imei').value;
					var desc = document.getElementById('sys_desc').value;
					log('Set desc for sys ' + imei + ' -> ' + desc);
					$.getJSON('/api/sys/desc?acckey='+config.akey+'&imei=' + imei + '&desc=' + desc, function (data) {
						if(data.result){
							result = data.result;
							if(result == "disabled"){
								//$("#dialog-need-admin").dialog('open');
							} else if(result == "ok") {
								//UpdateSysList();
								$("#sysdsc_"+imei).html(desc);
							}
						}
					});
					$(this).dialog('close');
				},
				'Отменить': function() {
					$(this).dialog('close');
				}
			}
		});



		$("#dialog-addsys-not-found").dialog({modal: true, autoOpen: false, buttons:{Ok: function(){$(this).dialog("close");}}});
		$("#dialog-addsys-already").dialog({modal: true, autoOpen: false, buttons:{Ok: function(){$(this).dialog("close");}}});
		$("#popup-sys").dialog({modal: true, autoOpen: false});
		$("#popup-sys li").button();


		$('#colorpickerHolder').ColorPicker({
			color: '#0000ff',
			onShow: function (colpkr) {
				$(colpkr).fadeIn(100);
				return false;
			},
			onHide: function (colpkr) {
				$(colpkr).fadeOut(100);
				return false;
			},
			onChange: function (hsb, hex, rgb) {
				$('#colorpickerHolder div').css('backgroundColor', '#' + hex);
			}
		});


		$("#config_list").accordion({fillSpace: true, collapsible: true});
		$("#config_sys_list").sortable({
			//delay: 500,
			//axis: 'y',
			//containment: 'parent',
			handle: '.msp',
			revert: true,
			scrollSpeed: 5,
			stop: function(event, ui){
				/*console.log(ui.item.index());
				console.log(ui.item.attr('imei'));
				console.log(ui);*/
				var imei = ui.item.attr('imei');
				var index = ui.item.index();
				$.getJSON('/api/sys/sort?acckey='+config.akey+'&imei=' + imei + '&index=' + index, function (data) {
					//window.location = "/config";
					//$(this).dialog('close');
					if(data.result){
						log('Set new position for ' + imei + ' to ' + index);
					}
				});

			},
		});
		$("#config_sys_list").disableSelection();

		$(window).resize(function(){$("#config_list").accordion("resize");});
		setTimeout(function(){$("#config_list").accordion("resize")}, 1000);

		{% if admin %}
		$("button.dbg_send_msg").click(function(){
			var imei = $(this).attr('imei');
			var text = $(this).attr('value');
			//sendGet('http://localhost/addlog?imei='+imei+'&text=%D0%92%D0%BD%D0%B5%D1%88%D0%BD%D0%B5%D0%B5+%D0%BF%D0%B8%D1%82%D0%B0%D0%BD%D0%B8%D0%B5:+%3Cb%3E%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%3C/b%3E');
			sendGet('/addlog?imei='+imei+'&text='+text);
		});
		{% endif %}

		$('select#cfg_theme option[value="'+config.ui.theme+'"]').attr('selected', 'selected');
		log('Set theme item:', config.ui.theme, $('select#cfg_theme option[value="'+config.ui.theme+'"]'));

	});

	$(document).bind('contextmenu', function(e) {return false;});
        //$(document).disableSelection();

	function SetTheme() {
		var themename = $('#cfg_theme').attr('value');
		log(themename);
		saveconfig('theme', themename);


		/*var headID = document.getElementsByTagName("head")[0];         
		var cssNode = document.createElement('link');
		cssNode.type = 'text/css';
		cssNode.rel = 'stylesheet';
		cssNode.href = 'FireFox.css';
		cssNode.media = 'screen';
		headID.appendChild(cssNode);
		*/
		var hl = $('head #themecss');
		hl.attr('href', '/plugins/jquery-ui-themes-1.8.7/jquery-ui-themes-1.8.7/themes/'+themename+'/jquery.ui.all.css');
		log(hl);
	}


  </script>

  <style>
	div#container {
		overflow: hidden;
	}
  </style>

</head>
<body>
<div id="switcher"></div>
	<div id="config_list">
		<h3><a href="#">Наблюдаемые системы</a></h3>
		<div>
			<button id="button_sys_update">Получить список</button>
			<ul id="config_sys_list">
				<li>Пусто</li>
			</ul>
		
			<button id="button_sys_add">Добавить систему</button>

		</div>
		<h3><a href="#">Настройки интерфейса</a></h3>
		<div>
			<div style="position: absolute; top:0px; bottom: 30px; left:0px; right:0px; overflow-y:auto; ">
				Временная зона: <button>+2</button><br/>
				Тема оформления:
				<select id="cfg_theme" name="cfg_theme" style="" onchange="SetTheme();">
					<option value="black-tie">black-tie</option>
					<option value="blitzer">blitzer</option>
					<option value="cupertino">cupertino</option>
					<option value="dark-hive">dark-hive</option>
					<option value="dot-luv">dot-luv</option>
					<option value="eggplant">eggplant</option>
					<option value="excite-bike">excite-bike</option>
					<option value="flick">flick</option>
					<option value="hot-sneaks">hot-sneaks</option>
					<option value="humanity">humanity</option>
					<option value="le-frog">le-frog</option>
					<option value="mint-choc">mint-choc</option>
					<option value="overcast">overcast</option>
					<option value="pepper-grinder">pepper-grinder</option>
					<option value="redmond">redmond</option>
					<option value="smoothness">smoothness</option>
					<option value="south-street">south-street</option>
					<option value="start">start</option>
					<option value="sunny">sunny</option>
					<option value="swanky-purse">swanky-purse</option>
					<option value="trontastic">trontastic</option>
					<option value="ui-darkness">ui-darkness</option>
					<option value="ui-lightness">ui-lightness</option>
					<option value="vader">vader</option>
				</select><br/>
				<div id="colorpickerHolder">Цвет трека: <div style="width: 16px; height: 16px; border: 2px solid black; display: inline; position: absolute;"></div></div>
			</div>
			<div style="position: absolute; bottom: 2px; left: 50%; margin-left: -100px;">
				<button>Сохранить</button>
				<button>Отменить</button>
			</div>
		</div>
		{% if admin %}
		<h3><a href="#">Административные настройки</a></h3>
		<div>
			<button class="dbg_send_msg" imei="356895035359317" value="Совершенно случайное сообщение на <b>русском</b>">Послать сообщение от системы 356895035359317</button>
			<button class="dbg_send_msg" imei="356895035359317" value="Совершенно другое случайное сообщение на совершенно другую тему все на том-же <b>русском</b>">Послать сообщение от системы 356895035359317</button>
		</div>
		{% endif %}

	</div>

	<div id="dialog-addsys" title="Добавление системы">
	<form>
		<label>Укажите IMEI добавляемой системы</label>
		<br />
       		<div><textarea id="addsys_imei" name="imei" rows="1" style="width:98%;"></textarea></div>
		<!--br /-->
		<!--label>Или номер SIM-карты в формате +380xxxxxxxxx</label>
		<br /><br />
       		<div><textarea id="addsys_phone" name="phone" rows="1" style="width:98%;"></textarea></div-->
	</form>
	</div>

	<div id="dialog-addsys-not-found" title="Ошибка">
	  <p>
		<span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
		Система не найдена.
	  </p>
	  <p>
		Возможно система ни разу не выходила на связь с сервером.
	  </p>
	</div>

	<div id="dialog-addsys-already" title="Ошибка">
	  <p>
		<span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
		Вы уже наблюдаете за этой системой.
	  </p>
	</div>

	<div id="dialog-sys-desc" title="Администрирование">
	<form>
		<label>Введите описание для системы IMEI:</label><label id="sysdesc_imei">IMEI</label>
		<br />
       		<div><textarea id="sys_desc" name="desc" rows="1" style="width:98%;"></textarea></div>
	</form>
	</div>
	
	<style>
		#popup-sys ul {
			list-style: none;
			margin: 0;
			padding: 0;
		}
		#popup-sys ul li {
			width: 100%;
			/*background-color: blue;*/
		}
	</style>
	
	<div id="popup-sys" title="Опции">
		<ul>
			<li>Конфигурация системы</li>
			<li>Настройка вида</li>
			<li>Показать на карте</li>
			<li style="margin-top: 16px;">Отказаться от слежения</li>
		</ul>
	</div>
</body>

