<!DOCTYPE html>
<html>
<head>
  <!--link type="text/css" href="/plugins/jquery-ui-themes-1.8.7/jquery-ui-themes-1.8.7/themes/cupertino/jquery-ui.css" rel="stylesheet"/-->
  <!--link type="text/css" href="/plugins/jquery-ui-themes-1.8.7/jquery-ui-themes-1.8.7/themes/flick/jquery-ui.css" rel="stylesheet" /-->
  <!--link type="text/css" href="/plugins/jquery-ui-themes-1.8.7/jquery-ui-themes-1.8.7/themes/humanity/jquery-ui.css" rel="stylesheet" /-->
  <!--link type="text/css" href="/plugins/jquery-ui-themes-1.8.7/jquery-ui-themes-1.8.7/themes/redmond/jquery-ui.css" rel="stylesheet" /-->

  <!--link type="text/css" href="/stylesheets/map.css" rel="stylesheet" /-->

  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!--script type="text/javascript" src="/plugins/jquery-ui-1.8.7.custom/js/jquery-ui-1.8.7.custom.min.js"></script-->

  <script type="text/javascript" src="/plugins/jquery-ui-1.8.7/jquery-ui-1.8.7/ui/jquery.ui.core.js"></script>
  <script type="text/javascript" src="/plugins/jquery-ui-1.8.7/jquery-ui-1.8.7/ui/jquery.ui.widget.js"></script>
  <script type="text/javascript" src="/plugins/jquery-ui-1.8.7/jquery-ui-1.8.7/ui/jquery.ui.button.js"></script>
  <script type="text/javascript" src="/js/alert.js"></script>
  <script src='/_ah/channel/jsapi'></script>

  <!--script type="text/javascript" src="/js/jquery-ui.min-1.8.7.js"></script-->
  <!--script type="text/javascript" src="http://jqueryui.com/themeroller/themeswitchertool/"></script-->

  <link type="text/css" href="/stylesheets/base.css" rel="stylesheet">


  <!--style>
       .ui-sortable-placeholder { border: 1px dotted black !important; visibility: visible !important; }
       .ui-sortable-placeholder * { visibility: hidden; }
  </style-->

  <script>
	window.updater = null;
	$(document).ready(function() {
		var connected = false;
	
		var sendMessage = function(path, opt_param) {
		  path += '?g=' + state.game_key;
		  if (opt_param) {
		    path += '&' + opt_param;
		  }
		  var xhr = new XMLHttpRequest();
		  xhr.open('POST', path, true);
		  xhr.send();
		}

		// Установим chanel-соединение
		// Получим токен для установки соединения
		var uuid = new Date().getTime();
		var url = '/api/chanel/gettoken?akey={{ account.key }}&uuid={{ uid }}-'+uuid;
		$.getJSON(url, function (data) {
			if(data.token){
				var token = data.token;
				console.log("Token goted:" + token);

				var onOpened = function() {
					console.log('goog.appengine.Channel: onOpened ('+token+')');
					connected = true;
					//sendMessage('opened');
					//updateBoard();
				}

				var onMessage = function(m) {
					var msg = JSON.parse(m.data);
					console.log("goog.appengine.Channel: onMessage");
					console.log(msg);
					connected = true;
					message("Получено сообщени об обновлении:<br />" + msg.msg + "<br />Для системы:" + msg.imei + "<br />Заметки:" + msg.comment);

					if(window.updater) window.updater(msg);

					//newState = JSON.parse(m);
					//console.log("goog.appengine.Channel message: " + newState.text);
					//$("#channel_msg").html(newState.text || "error message");
				}

				var onError = function() {
					console.log("goog.appengine.Channel: onError");
				}

				var onClose = function() {
					console.log("goog.appengine.Channel: onClose");
					connected = false;
				}

				// Чуть снизим нагрузку для локальной отладки
				//if(document.URL.match(/localhost/g1)){
				if(window.location.hostname == 'localhost'){
					if(goog.appengine.Socket.POLLING_TIMEOUT_MS)
						goog.appengine.Socket.POLLING_TIMEOUT_MS = 2000;
				}
				var channel = new goog.appengine.Channel(token);
				var socket = channel.open();
				socket.onopen = onOpened;
				socket.onmessage = onMessage;
				socket.onerror = onError;
				socket.onclose = onClose;
			}
		});

		//$(document).bind('contextmenu', function(e) {return false;});	// Запретим правую клавишу вобще и везде
		$('.nosel').disableSelection();
		$("button").button();
		//$('#switcher').themeswitcher();


		/*$("#navigate").buttonset();*/
		
		$(".btn_menu:first").button({icons: {primary: "ui-icon-zoomin"}}).
		next().button({icons: {primary: "ui-icon-info"}}).
		next().button({icons: {primary: "ui-icon-alert"}}).
		next().button({icons: {primary: "ui-icon-document"}}).
		next().button({icons: {primary: "ui-icon-gear"}}).
		next().button({icons: {primary: "ui-icon-help"}});

		$(".btn_menu").click(function(){
			//console.log($(this).attr('href'));
			window.location = $(this).attr('href');
		});

		//logout


	});
  </script>

  <style>

	div#header {
		position: relative;
		height: 25px;
		/*background-color: #ff0;*/
	}

	div#container {
		position: absolute;
		top: 25px;
		bottom: 0px;
		left: 0px;
		right: 0px;
		/*background-color: #f0f;*/
		/*overflow: hidden;*/
		overflow: auto;
	}
	div#login {
		position: absolute;
		top: 50%;
		margin-top: -10px;
		right: 10px;
	}

	.ui-state-disabled[name="btn_menu"] {
		opacity: 1.0;
		/*border: 2px solid black;*/
		background-color: #cfc;
	}

  </style>

{% block head %}{% endblock %}

</head>

<body>
	<div id="header" class="nosel">
		<div id="control">
			<div id="navigate">
		<!--a class="btn_menu" id="btn_map" href="/s/Map">Карта</button>
		<a class="btn_menu" id="btn_reports" href="/s/Reports">Отчеты</button>
		<a class="btn_menu" id="btn_logs" href="/s/Logs">События</button>
		<a class="btn_menu" id="btn_gps" href="/s/Geos">Экспорт GPS</button>
		<a class="btn_menu" id="btn_configs" href="/s/Config">Настройки</button>
		<a class="btn_menu" id="btn_help" href="/s/Help">Помощь</a-->
				<button class="btn_menu" name="btn_menu" id="nav_map" href="/s/Map">Карта</button>
				<button class="btn_menu" name="btn_menu" id="nav_reports" href="/s/Reports">Отчеты</button>
				<button class="btn_menu" name="btn_menu" id="nav_logs" href="/s/Logs">События</button>
				<button class="btn_menu" name="btn_menu" id="nav_geos" href="/s/Geos">Экспорт GPS</button>
				<button class="btn_menu" name="btn_menu" id="nav_config" href="/s/Config">Настройки</button>
				<button class="btn_menu" name="btn_menu" id="nav_help" href="/s/Help">Помощь</button>
			</div>

		</div>
		<!--div id="switcher"></div-->
		<div id="login">
			<span title="Вы вошли как {{ username }}"><b>{{ username }}</b></span>
		        <a class="smallButton" href="{{ login_url }}" title="Войти под другим именем">X</a>
			<button class="btn_menu" id="logout" href="{{ login_url }}">Выйти</button>
		</div>
	</div>
	<div id="container">
{% block body %}{% endblock %}
	</div>
</body>
</html>
