<!doctype html>  

<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ --> 
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->

<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame 
       Remove this if you use the .htaccess -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>GPS наблюдение</title>
  <meta name="description" content="GPS logging">
  <meta name="author" content="Batrak Denis">

  <!--  Mobile viewport optimized: j.mp/bplateviewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS : implied media="all" -->
  <link rel="stylesheet" href="/stylesheets/style.css?v=2">
  <!-- Uncomment if you are specifically targeting less enabled mobile browsers
  <link rel="stylesheet" media="handheld" href="css/handheld.css?v=2">  -->

  <link id="themecss" type="text/css" href="/plugins/jquery-ui-themes-1.8.7/jquery-ui-themes-1.8.7/themes/{{ account.pconfig.theme }}/jquery.ui.all.css" rel="stylesheet">
  <link type="text/css" href="/stylesheets/tabs.css" rel="stylesheet">

  <!--script type="text/javascript" src="/js/jquery.min.js"></script-->

  <!-- Grab Google CDN's jQuery. fall back to local if necessary -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/jquery.min.js"%3E%3C/script%3E'))</script>

  <script type="text/javascript" src="/js/jquery.cookie.js"></script>
  <!--script type="text/javascript" src="/js/jquery-ui.min-1.8.7.js"></script-->

  <!-- Grab Google CDN's jQuery. fall back to local if necessary -->
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.7/jquery-ui.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/js/jquery-ui.min-1.8.7.js"%3E%3C/script%3E'))</script>

  <script type="text/javascript" src="/js/jquery.ui.datepicker-ru.js"></script>

  <!--script type="text/javascript" src="/plugins/jquery-ui-1.8.7/jquery-ui-1.8.7/ui/jquery.ui.core.js"></script>
  <script type="text/javascript" src="/plugins/jquery-ui-1.8.7/jquery-ui-1.8.7/ui/jquery.ui.widget.js"></script>
  <script type="text/javascript" src="/plugins/jquery-ui-1.8.7/jquery-ui-1.8.7/ui/jquery.ui.button.js"></script>
  <script type="text/javascript" src="/plugins/jquery-ui-1.8.7/jquery-ui-1.8.7/ui/jquery.ui.tabs.js"></script-->
  <script type="text/javascript" src="/js/alert-min.js"></script>

  <script src='/_ah/channel/jsapi'></script>

  <!--script src="/js/googlemaps/js" type="text/javascript"></script-->
  <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>

  <script src="/js/base.js"></script>
  <script src="/js/mymarker.js"></script>
  <script src="/js/lastmarker.js"></script>
  <!--script src="/js/lastmarker-min.js"></script-->
  <script src="/js/maps.js"></script>
  <script src="/js/gmap.js"></script>

  <!--[if lt IE 7 ]>
    <script src="js/libs/dd_belatedpng.js"></script>
    <script> DD_belatedPNG.fix('img, .png_bg'); //fix any <img> or .png_bg background-images </script>
  <![endif]-->


  <!-- yui profiler and profileviewer - remove for production ->
  <script src="/js/profiling/yahoo-profiling.min.js"></script>
  <script src="/js/profiling/config.js"></script>
  <!- end profiling code -->


  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20843583-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script>

  <script>
	var config = {};
	config.skey = "{{ account.systems.0.key }}";
	config.akey = "{{ account.key }}";
	{% if admin %}
	config.admin = true;
	{% else %}
	config.admin = false;
	{% endif %}


	// Система автообновления
	config.updater = {}
	config.updater.queue = {};

	config.updater.add = function(msg, foo){
		config.updater.queue[msg] = config.updater.queue[msg] || [];
		config.updater.queue[msg].push(foo);
	}

	config.updater.add('*', function(msg){
		//console.log("goog.appengine.Channel: onMessage");
		//console.log(msg);
		log('goog.appengine.Channel: onMessage:', msg);
		connected = true;
		message('Получено сообщени об обновлении:<b>' + msg.msg + '</b>');
	});

	log('Default updater', config.updater);
	//log(config.updater);

	//$.getJSON('/api/info?acckey='+config.akey, function (data) {
	//}

	config.systems = [];
	{% for sys in account.systems %}
	config.systems.push({
		'imei': '{{ sys.imei }}',
		'skey': '{{ sys.key }}',
		'desc': '{{ sys.desc }}'
	});
	{% endfor %}

	config.ui = {{ account.config }};
	//console.log("ConfigUI: ");
	//console.log(config.ui);
	log("ConfigUI: ", config.ui);

	config.updater.add('changedesc', function(msg) {
		//console.log('Обработчик события для обновления списка config.systems');
		//console.log(msg);
		log('Обработчик события для обновления списка config.systems', msg);
		for(var i in config.systems){
			if(config.systems[i].skey == msg.data.skey){
				config.systems[i].desc = msg.data.desc;
			}
		}
		//console.log('CONFIG==');
		//console.log(config);
		log('CONFIG==', config);
	});

	//console.log('CONFIG==');
	//console.log(config);
	log('CONFIG==', config);

	$(document).ready(function() {

		//$('head link:first').before('<link id="themecss" type="text/css" href="/plugins/jquery-ui-themes-1.8.7/jquery-ui-themes-1.8.7/themes/blitzer/jquery.ui.all.css" rel="stylesheet">');

		$("button").button();
		var $tabs = $("#tabs").tabs({
			cookie: { expires: 30, name: 'maintab' },
			//cookie: { expires: 7, path: '/', domain: 'localhost', secure: true },
			//cookie: { expires: 7, name: 't'},
			effect: 'ajax',
			cache: true,
			spinner: 'Retrieving data...',
			show: function(){
				/*console.*/log('TAB: show: ', $(this).tabs( "option", "selected" ));
			},
			load: function(){
				/*console.*/log('TAB: tab loaded: ', $(this).tabs( "option", "selected" ));
				$("button").button();

			}
		});

		$("button#tabreload").click(function(){
			/*console.*/log('Reload tab...');
			//var tabs = $('#tabs').tabs;
			//console.log($tabs);
			//var index = $tabs.tabs('option', 'selected');
			//console.log($tabs.tabs("option", "selected"));
			$tabs.tabs('load', $tabs.tabs('option', 'selected'));
		});

		var connected = false;
	
		// Установим chanel-соединение
		// Получим токен для установки соединения
		var uuid = new Date().getTime();
		var url = '/api/chanel/gettoken?akey={{ account.key }}&uuid={{ uid }}-'+uuid;
		$.getJSON(url, function (data) {
			if(data.token){
				var token = data.token;
				/*console.*/log("Token goted:" + token);

				var onOpened = function() {
					/*console.*/log('goog.appengine.Channel: onOpened ('+token+')');
					connected = true;
					//sendMessage('opened');
					//updateBoard();
				}

				var onMessage = function(m) {
					var msg = JSON.parse(m.data);

					//if(window.updater) window.updater(msg);
					if(config.updater.queue[msg.msg]){
						for(var i in config.updater.queue[msg.msg]){
							config.updater.queue[msg.msg][i](msg);
						}
					}
					if(config.updater.queue['*']){
						for(var i in config.updater.queue['*']){
							config.updater.queue['*'][i](msg);
						}
					}

					if(0){
					for(var i in config.updater){
						config.updater[i](msg);
						/*(function(msg){
							updater[i](msg);
							//updater[i].call(1);
							//updater[i].apply(1);
						})(msg);*/
					}
					}

					//newState = JSON.parse(m);
					//console.log("goog.appengine.Channel message: " + newState.text);
					//$("#channel_msg").html(newState.text || "error message");
				}

				var onError = function() {
					/*console.*/log("goog.appengine.Channel: onError");
				}

				var onClose = function() {
					/*console.*/log("goog.appengine.Channel: onClose");
					connected = false;
				}

				// Чуть снизим нагрузку для локальной отладки
				//if(document.URL.match(/localhost/g1)){
				if(window.location.hostname == 'localhost'){
					if(goog.appengine.Socket.POLLING_TIMEOUT_MS)
						goog.appengine.Socket.POLLING_TIMEOUT_MS = 2000;
				}
				var channel = new goog.appengine.Channel(token);
				var socket = channel.open();
				socket.onopen = onOpened;
				socket.onmessage = onMessage;
				socket.onerror = onError;
				socket.onclose = onClose;
			}
		});

		$('#test').click(function(){
			/*console.*/log('Test');
		});

	});
	//$("#draggable").draggable();
  </script>
  <style>
	div#logout {
		position: absolute;
		top: 0px;
		right: 0px;
	}

	{% if not admin %}
	.admin {
		display: none;
	}
	{% endif %}

  </style>
</head>

<body>
	<div id="tabs">
	  <!--div style="position: absolute; left:0px; top:0px;">C</div-->
	  <ul>
	    <li><a href="/html/Tab_Map.html"><span class="ui-icon ui-icon-zoomin"></span>Карта</a></li>
	    <li><a href="/html/Tab_Reports.html"><span class="ui-icon ui-icon-info"></span>Отчеты</a></li>
	    <li><a href="/html/Tab_Logs.html"><span class="ui-icon ui-icon-alert"></span>События</a></li>
	    <li><a href="/html/Tab_Geos.html"><span class="ui-icon ui-icon-document"></span>Экспорт GPS</a></li>
	    <li><a href="/html/Tab_Config.html"><span class="ui-icon ui-icon-gear"></span>Настройка</a></li>
	    <li><a href="/html/Tab_Help.html"><span class="ui-icon ui-icon-help"></span>Помощь</a></li>
	  </ul>
	</div>
	<div id="logout">
		<a href="{{ login_url }}">{{ username }}</a>
		<!--button id="tabreload">Reload</button-->
		<button id="test">Test</button>
	</div>
</body>
